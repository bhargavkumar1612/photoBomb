name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  GKE_CLUSTER: photobomb-prod-gke

jobs:
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio
    
    - name: Run linting
      run: |
        pip install ruff
        ruff check . --select=E,F,I
    
    - name: Run tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
        REDIS_URL: redis://localhost:6379/0
      run: |
        pytest tests/ -v --cov=app --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: frontend
      run: npm ci
    
    - name: Run linting
      working-directory: frontend
      run: npm run lint
    
    - name: Run tests
      working-directory: frontend
      run: npm test -- --coverage
    
    - name: Build
      working-directory: frontend
      run: npm run build

  build-and-push:
    name: Build and Push Docker Images
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker
      run: gcloud auth configure-docker
    
    - name: Build and push API image
      run: |
        docker build -t gcr.io/$GCP_PROJECT_ID/photobomb-api:${{ github.sha }} \
          -t gcr.io/$GCP_PROJECT_ID/photobomb-api:latest \
          -f backend/Dockerfile backend/
        docker push gcr.io/$GCP_PROJECT_ID/photobomb-api:${{ github.sha }}
        docker push gcr.io/$GCP_PROJECT_ID/photobomb-api:latest
    
    - name: Build and push worker image
      run: |
        docker build -t gcr.io/$GCP_PROJECT_ID/photobomb-worker:${{ github.sha }} \
          -t gcr.io/$GCP_PROJECT_ID/photobomb-worker:latest \
          -f backend/Dockerfile.worker backend/
        docker push gcr.io/$GCP_PROJECT_ID/photobomb-worker:${{ github.sha }}
        docker push gcr.io/$GCP_PROJECT_ID/photobomb-worker:latest

  deploy-api:
    name: Deploy to Cloud Run
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy photobomb-api \
          --image=gcr.io/$GCP_PROJECT_ID/photobomb-api:${{ github.sha }} \
          --region=$GCP_REGION \
          --platform=managed \
          --allow-unauthenticated

  deploy-workers:
    name: Deploy Workers to GKE
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER \
          --region=$GCP_REGION
    
    - name: Deploy to GKE
      run: |
        kubectl set image deployment/thumbnail-worker \
          worker=gcr.io/$GCP_PROJECT_ID/photobomb-worker:${{ github.sha }} \
          -n photobomb
        kubectl rollout status deployment/thumbnail-worker -n photobomb

  e2e-tests:
    name: E2E Tests (Production)
    needs: [deploy-api, deploy-workers]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Playwright
      run: |
        npm install -D @playwright/test
        npx playwright install --with-deps
    
    - name: Run E2E tests
      env:
        BASE_URL: https://api.photobomb.app
      run: npx playwright test
    
    - name: Upload test results
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: playwright-results
        path: test-results/
