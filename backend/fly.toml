# fly.toml app configuration file generated for photobomb-backend on 2024-01-10

app = "photobomb-backend"
primary_region = "syd" # Sydney, Australia (Matching Supabase)

[deploy]
  release_command = "alembic upgrade head"

[build]
  dockerfile = "Dockerfile"

[env]
  PORT = "8000"
  # You will need to set these using `fly secrets set` or `fly deploy -e ...`
  # DATABASE_URL and REDIS_URL will be set automatically by 'fly postgres attach' and 'fly redis attach'
  # DATABASE_URL=...
  # REDIS_URL=...
  # B2 credentials (you can leave placeholders for now):
  B2_APPLICATION_KEY_ID=003eca2360e92400000000001
  B2_APPLICATION_KEY=K003CBJTNMdnyBX9JehK70QlKDKn8rM
  # B2_APPLICATION_KEY_NAME=photobomb-production-key
  B2_BUCKET_NAME=photobomb-production-bhargav
  B2_BUCKET_ID=1e3cea228376009e99b20410
  GOOGLE_CLIENT_ID=416607458916-2arj516g6ntk59ahmhuajin6ts7svs11.apps.googleusercontent.com
  GOOGLE_CLIENT_SECRET=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
  APP_NAME=PhotoBomb
  APP_ENV=development
  DEBUG=true
  ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,https://photobomb.bhargavkumar1612.workers.dev


# Define processes: one for web app, one for celery worker
[processes]
  app = "uvicorn app.main:app --host 0.0.0.0 --port 8000"
  worker = "celery -A app.celery_app worker -Q high -c 4 --loglevel=info"

# Configure the HTTP service (only for the 'app' process)
[[services]]
  processes = ["app"]
  protocol = "tcp"
  internal_port = 8000
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 1

  [[services.ports]]
    port = 80
    handlers = ["http"]
    force_https = true

  [[services.ports]]
    port = 443
    handlers = ["tls", "http"]
  
  [[services.tcp_checks]]
    interval = "10s"
    timeout = "2s"
    grace_period = "5s"
